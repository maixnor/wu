---
title: "Business Analytics II - Group 1 - Home Assignment 5"
author: "Yurii Masiuk, Vanda Lakatos, Kornel Auer, Vivien Arns, Benjamin Meixner, Nicholas Olsa"
date: "2024-12-12"
output: 
  pdf_document:
    latex_engine: tectonic
---

We solved all tasks.

# Exercise 1

```{r}
# Load necessary libraries
library(xts)
library(zoo)
library(lubridate)
library(ggplot2)

# Load the stock return data
load("../data/returns_hw4.RData")  # The variable 'r' contains the returns

# Load Fama-French factors
ff_factors <- read.csv("../data/F-F_Research_Data_Factors.CSV")

# Process Fama-French data
ff_factors$Date <- as.Date(paste0(ff_factors$X, "01"), format="%Y%m%d")
ff_factors_xts <- xts(ff_factors, order.by = ff_factors$Date)

head(r)
head(ff_factors_xts)

# Align dates and merge with stock returns
returns_data <- merge(r, ff_factors_xts, by="Date", all=FALSE)

# Select three stocks for analysis
selected_stocks <- returns_data[, 1:3]
stock_names <- colnames(selected_stocks)

# Define the risk-free rate
rf_rate <- returns_data$RF

# Calculate market excess returns
excess_market_returns <- returns_data$`Mkt-RF`

# Function to calculate CAPM beta and alpha
calc_capm <- function(stock_returns, market_excess_returns, rf_rate) {
  excess_stock_returns <- stock_returns - rf_rate
  model <- lm(excess_stock_returns ~ market_excess_returns)
  return(summary(model))
}

# Calculate CAPM beta and alpha for each selected stock
capm_results <- lapply(1:ncol(selected_stocks), function(i) {
  calc_capm(selected_stocks[, i], excess_market_returns, rf_rate)
})

# Display CAPM results
for (i in 1:length(capm_results)) {
  cat("CAPM Results for", stock_names[i], ":\n")
  print(capm_results[[i]])
  cat("\n")
}

# Extend the model with Fama-French Three-Factor Model
calc_ff3 <- function(stock_returns, market_excess_returns, smb, hml, rf_rate) {
  excess_stock_returns <- stock_returns - rf_rate
  model <- lm(excess_stock_returns ~ market_excess_returns + smb + hml)
  return(summary(model))
}

smb <- returns_data$SMB
hml <- returns_data$HML

# Calculate FF3 factors for each selected stock
ff3_results <- lapply(1:ncol(selected_stocks), function(i) {
  calc_ff3(selected_stocks[, i], excess_market_returns, smb, hml, rf_rate)
})

# Display FF3 results
for (i in 1:length(ff3_results)) {
  cat("Fama-French Three-Factor Results for", stock_names[i], ":\n")
  print(ff3_results[[i]])
  cat("\n")
}

# Compare CAPM and FF3 models by plotting residuals
par(mfrow = c(2, 1))
for (i in 1:ncol(selected_stocks)) {
  capm_resid <- capm_results[[i]]$residuals
  ff3_resid <- ff3_results[[i]]$residuals
  plot(capm_resid, main = paste("CAPM Residuals for", stock_names[i]), ylab = "Residuals")
  plot(ff3_resid, main = paste("FF3 Residuals for", stock_names[i]), ylab = "Residuals")
}

# Interpret the results
```
